from exploitation_auto_pix_orga import *
import io

test_bibliotheque = True
test_pdf = True

try : 
    import pandas as pd
except:
    print("!!! Bibliothèque pandas absente. Installez la bibliothèque pandas. !!!")
    test_bibliotheque = False

try : 
    from xhtml2pdf import pisa
except:
    print("!!! Bibliothèque xhtml2pdf absente. Pas de sortie pdf possible. Sortie en html !!!")
    test_pdf = False

def formatageA3portrait(taille_police=12):
    taille_police2 = str(taille_police + 2)
    taille_police4 = str(taille_police + 4)
    taille_police = str(taille_police)
    # Format A3 842 x 1 191 px
    formatageA3portrait = '<style type="text/css">'\
    ' @page {@frame content_frame {left: 28pt;width: 786pt;top: 28pt;height: 1135pt;-pdf-frame-border: 1;}'\
    ' size: A3 portrait}'\
    ' h1 {font-size: '+taille_police4+'px}'\
    ' h2 {font-size: '+taille_police2+'px}'\
    ' h1, h2, h3 {margin-bottom: 0;padding-bottom: 0;}'\
    ' body,p,h3 {font-size: '+taille_police+'px}'\
    ' table{ font-size: '+taille_police+'px ;font-family: sans-serif; border-collapse: collapse;  }'\
    ' td, th{border: 1px solid #ddd; padding: 3px;}'\
    ' th{text-align: left;  background-color: #1e7375;  color: white;}'\
    ' tr{padding:1px}'\
    ' tr:nth-child(even){background-color: #f2f2f2;}'\
    ' a{text-decoration:none; color:black; }'\
    ' </style>'
    return formatageA3portrait


def liste_emargements_html(session_detail, candidats,code_acces=False):
    texte_HTML=""    
    if session_detail.iloc[0]['Status'] != 'created':
        return texte_HTML

    session_id = session_detail.iloc[0]['Numéro Session']

   
    
    texte_HTML += "<h2>PIX - Feuille d'émargements</h2>"
    if code_acces :
        texte_HTML += session_detail.loc[:,['Date','Heure','Salle','Surveillants','Signatures' ]].to_html(index=False)
        texte_HTML += session_detail.loc[:,['Numéro Session',"Code d'accès",'Code non certifiables','Mot de passe de session - Surveillant']].to_html(index=False)

    else :
        texte_HTML += session_detail.loc[:,['Numéro Session','Date','Heure','Salle' ]].to_html(index=False)
        texte_HTML += session_detail.loc[:,['Nombre de candidats inscrits','Nombre de présents','Surveillants','Signatures']].to_html(index=False)
    
        
    texte_HTML += '<p>Participants</p>'
    candidats_session=candidats[candidats[session_id].notna()]
    candidats_session=candidats_session.loc[:,['Classe','Nom du Participant','Prénom du Participant','Date de naissance','Temps majoré (O/N)','Signature','Écran de fin de test vu (cocher)']]
    texte_HTML += candidats_session.to_html(index=False)
    texte_HTML += '<div style="page-break-before:always">&nbsp;</div>'
    texte_HTML = texte_HTML.replace("<th>Classe</th>","<th style='width:80px;'>Classe</th>")
    texte_HTML = texte_HTML.replace("<th>Date de naissance</th>","<th style='width:80px;'>Date de naissance</th>")
    texte_HTML = texte_HTML.replace("<th>Temps majoré (O/N)</th>","<th style='width:50px;'>Temps majoré (O/N)</th>")
    texte_HTML = texte_HTML.replace("<th>Signature</th>","<th style='width:100px;'>Signature</th>")
    texte_HTML = texte_HTML.replace("<th>Écran de fin de test vu (cocher)</th>","<th style='width:60px;'>Écran de fin de test vu (cocher)</th>")

    return texte_HTML

def page_de_garde_html(session_detail,consignes_html):
    texte_HTML=""
    if session_detail.iloc[0]['Status'] != 'created':
        return texte_HTML
    

    
    texte_HTML += session_detail.loc[:,['Date','Heure','Salle','Surveillants' ]].to_html(index=False)
    texte_HTML += session_detail.loc[:,['Numéro Session',"Code d'accès",'Code non certifiables','Mot de passe de session - Surveillant']].to_html(index=False)
    texte_HTML += session_detail.loc[:,['Nombre de candidats inscrits','Classes concernées','Observations']].to_html(index=False)
    texte_HTML += consignes_html
    texte_HTML += '<div style="page-break-before:always">&nbsp;</div>'
    
    return texte_HTML


def sortie_dossier(sessions_detail,candidats,code_non_certifiables,sortie_html,sortie_pdf,page_garde,code_surveillant,multidoc=False,test_pdf=test_pdf):
    sortie_html= (sortie_pdf and not(test_pdf)) or sortie_html
    sortie_pdf= sortie_pdf and test_pdf
    
    # Ajout de colonnes non informatives, uniquement pour la présentation
    sessions_detail=sessions_detail.assign(Signatures=".",code_non_certifiables=code_non_certifiables,presents=".")
    colonnes = {'code_non_certifiables':'Code non certifiables','presents':'Nombre de présents'}
    sessions_detail.rename(columns = colonnes, inplace = True)  
    candidats=candidats.assign(Tempsmajore = ".", Signature = ".",Coche=".")
    colonnes = {'Tempsmajore':'Temps majoré (O/N)','Coche':'Écran de fin de test vu (cocher)'}
    candidats.rename(columns = colonnes, inplace = True)        
    
    # Lecture du fichier contenant les consignes
    if page_garde :
        # Pour gérer le changement de février 2022
        if code_surveillant :
            nom_fichier_consignes = 'consignessurveillants_CLG.html'
        else :
            nom_fichier_consignes = 'consignessurveillants_LYC.html'
        try :
            fichier_consignes = open(nom_fichier_consignes, "r", encoding='utf8')
            consignes_html = fichier_consignes.read()
            fichier_consignes.close() 
        except :
            consignes_html = "Retrouvez les consignes dans le dossier"


        

    texte_HTML=formatageA3portrait(12)

        
    for session_id in sessions_detail['Numéro Session'] :
        session_detail = sessions_detail[sessions_detail['Numéro Session']==session_id]

        if page_garde :
            texte_HTML +=page_de_garde_html(session_detail,consignes_html)
            code_acces = False
        else :
            code_acces = True
            
        texte_HTML += liste_emargements_html(session_detail,candidats,code_acces)
        


    repertoire = "Documents-Certif-Auto"
    os.makedirs(repertoire, exist_ok=True)
    nom_du_fichier = "Liste d'émargements"
    
    ecriture_sorties(nom_du_fichier,repertoire,texte_HTML,"",sortie_html,sortie_pdf,False,test_pdf)
    
    

    
date_mise_a_jour_github('Preparation-Documents-PIX-certif')
            
if __name__ == "__main__":
    sortie_html=False
    sortie_pdf=True
    sortie_csv=False
    Code_acces =False
    

    
    username,password = donnees_perso()
    
    code_non_certifiables = input('Code pour les non certifiables ? ')
    code_non_certifiables = code_non_certifiables.upper()
    if code_non_certifiables == '' :
        code_non_certifiables = 'Non renseigné'

# Pour gérer le changement de février 2022
    code_surveillant = input('Lycée ou Collège (L/C) ? ')
    code_surveillant = code_surveillant.upper()
    if code_surveillant in ['L','LYCEE','LYCÉE']:

        code_surveillant = False
    else :
        code_surveillant = True

    page_garde = input("Création d'une page de garde par session (o/n) par défaut : Oui ? ")
    if page_garde in ['Non','NON','non','N','n']:
        page_garde = False
    else :
        page_garde =True
        print('!!! Imprimer en recto verso pour obtenir des pochettes      !!!')



    token_orga,user_id_orga=identification_orga(username,password)
    organisation_id=choix_organisation(token_orga,user_id_orga)

    token_certif,user_id_certif=identification_certif(username,password)
    centre_id=choix_centre(token_certif)

    del username
    del password
    


    eleves_detail =liste_eleves_detail(token_orga,organisation_id)
    eleves = liste_eleves(eleves_detail)

    sessions = liste_sessions(token_certif,centre_id)
    candidats = liste_candidats(token_certif,centre_id,sessions)
    sessions_detail = liste_sessions_detail(sessions,candidats,'certif',sortie_html,sortie_pdf,sortie_csv)

# Pour gérer le changement de février 2022
    if not(code_surveillant) :
        sessions_detail['Mot de passe de session - Surveillant'] = 'Mot de passe de session Inutile '


    sortie_dossier(sessions_detail,candidats,code_non_certifiables,sortie_html,sortie_pdf,page_garde,code_surveillant)

    print('!!! Imprimez en A3 pour le confort de lecture, le texte reste lisible en A4 !!!')
